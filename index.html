<!DOCTYPE html>
<html lang="ja">
    
<head>
<meta charset="UTF-8">
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='application-name' content='SNiBLE画像アップロード'/>
<meta name='apple-mobile-web-app-title' content='SNiBLE画像アップロード'>
  <title>SONIMAGE</title>
  <style>
  body{
    font-size:30px
  }
  input {
    font-size:50px;
    margin:1px;
    padding:1px;
    height:1.5em;
    -webkit-appearance: none;
    border-radius: 0;
  }
  </style>
</head>

<body bgcolor="#303030" text="#cccccc" onmousedown="preventFocus(event);" style="margin:20px;">
  <p>装置番号
     <input type="number" id="bus_id" oninput="CreatePatientID();" onfocus="toggleFocus(this)" onblur="toggleFocus(this)" min="0" max="99" value='' style="width:2em;">
     <input type="button" id="abd_btn" onmousedown="preventFocus();" value="腹部(A)" style="width:5em;height:2em">
     <input type="button" id="brest_btn" onmousedown="preventFocus();" value="乳腺(B)" style="width:5em;height:2em"></p>
  <p>受付暗号
     <input type="number" id="input_id" oninput="CreatePatientID();" onfocus="toggleFocus(this)" onblur="toggleFocus(this)" min="0" max="99999" value='' style="width:5em;">
     <input type="button" id="clear_btn" onmousedown="preventFocus();" value="×" style="width:100px;"></p>
  <p><input type="text"   id="submit_id" oninput="CreatePatientID();" onfocus="toggleFocus(this)" onblur="toggleFocus(this)" style="font-size:0.7em;width:13em;"></p>
  <p><div id="qrcodearea"></div></p>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/1.0.30/encoding.min.js"></script>
  <script>
  window.addEventListener('DOMContentLoaded', function(){
    // input要素を取得
    var bus_id = document.getElementById("bus_id");
    var input_id = document.getElementById("input_id");
    var submit_id = document.getElementById("submit_id");
    var abd_btn = document.getElementById("abd_btn");
    var brest_btn = document.getElementById("brest_btn");
    var clear_btn = document.getElementById("clear_btn");

    abd_btn.style.backgroundColor = "deepskyblue";
    brest_btn.style.backgroundColor = "darkgray";


    abd_btn.addEventListener("click",function(){
      abd_btn.style.backgroundColor = "deepskyblue";
      brest_btn.style.backgroundColor = "darkgray";
      CreatePatientID();
    });
    brest_btn.addEventListener("click",function(){
      abd_btn.style.backgroundColor = "darkgray";
      brest_btn.style.backgroundColor = "deeppink";
      CreatePatientID();
    });
    abd_btn.addEventListener("click",function(){
      abd_btn.style.backgroundColor = "deepskyblue";
      brest_btn.style.backgroundColor = "darkgray";
      CreatePatientID();
    });
    clear_btn.addEventListener("click",function(){
      input_id.value=0;
      CreatePatientID();
    });

    var bus_id = document.getElementById("bus_id");
    if( localStorage.getItem( "BusNumber" )==null ){
      localStorage.BusNumber=0;
    }
    bus_id.value = localStorage.BusNumber;

    bus_id.style.backgroundColor="lavender";
    input_id.style.backgroundColor="lavender";
    submit_id.style.backgroundColor="lavender";
    input_id.focus();

    CreatePatientID();

  });

  function toggleFocus(el)
  {
    el.style.backgroundColor =  el.style.backgroundColor=="pink" ? "lavender" : "pink";
  }

  function CreatePatientID() {
    var bus_id = document.getElementById("bus_id");
    var input_id = document.getElementById("input_id");
    var abd_btn = document.getElementById("abd_btn");
    var brest_btn = document.getElementById("brest_btn");
    var exam;
    if( abd_btn.style.backgroundColor == "deepskyblue" ){
      exam = 'A';
    }else{
      exam = 'B';
    }
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yy = today.getFullYear()%100;
    today = yy+mm+dd;
    bus_id.value = ( '00' + bus_id.value ).slice( -2 );
    input_id.value = ( '00000' + input_id.value ).slice( -5 );
    submit_id.value = today + exam+( '00' + bus_id.value ).slice( -2 )+'-'+( '00000' + input_id.value ).slice( -5 );

    localStorage.BusNumber=bus_id.value;

    var strqrorg = $('#submit_id').val();
    var strqrsjis = Encoding.convert(strqrorg, 'SJIS');
    $('#qrcodearea').html('');
    $('#qrcodearea').qrcode({width: 512, height: 512, text: strqrsjis});
    $('#id').text(strqrorg);
  }

  function preventFocus(e) {
    if( e && (e.srcElement.id == "bus_id" ||  e.srcElement.id == "input_id" ||  e.srcElement.id == "submit_id"))
    {
      e.stopPropagation();
    }
    else
    {
      var ae = document.activeElement;
      setTimeout(function() { ae.focus() }, 1);
    }
  }
  </Script>
</body>
</html>

